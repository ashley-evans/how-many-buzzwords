Transform: AWS::Serverless-2016-10-31
Description: Overall template for the Buzzword Application AWS Stack
Resources:
  WibbleDynamoDB:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: "WibbleTable"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        -
          AttributeName: pk
          AttributeType: S
      KeySchema:
        -
          AttributeName: pk
          KeyType: HASH
  NodeModuleDependencyLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      CompatibleRuntimes: 
        - nodejs14.x
      ContentUri: ../
      Description: Production node module dependency layer
      LayerName: node-module-dependency-layer
    Metadata:
      BuildMethod: makefile
  LambdaDBAccessRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: LambdaDBAccessRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
          Action:
          - sts:AssumeRole
      Path: /
      Policies:
        - PolicyName: LambdaReadWriteDynamoPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Action:
                  - dynamodb:PutItem
                Resource:
                  - Fn::GetAtt:
                    - WibbleDynamoDB
                    - Arn
                Effect: Allow
  WibbleLambda:
    Type: AWS::Serverless::Function
    Properties:
      Handler: wibble.handler
      Role:
        Fn::GetAtt:
        - LambdaDBAccessRole
        - Arn
      Runtime: nodejs14.x
      CodeUri: ../functions/wibble
      Description: Inserts a wibble entry into the Wibble DynamoDB table
      Layers:
        - Ref: NodeModuleDependencyLayer
      Timeout: 10
      Events:
        ApiGatewayEvent:
          Type: HttpApi
          Properties:
            ApiId: 
              Ref: BuzzwordHTTPGateway
            Method: ANY
            Path: /wibble
            PayloadFormatVersion: '2.0'
  BuzzwordHTTPGateway:
    Type: AWS::Serverless::HttpApi
    Properties:
      Description: Lambda Proxy
      StageName: prod
